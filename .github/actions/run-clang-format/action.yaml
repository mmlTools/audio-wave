name: Run clang-format
description: Runs clang-format and checks for any changes introduced by it

inputs:
  failCondition:
    description: Controls whether failed checks also fail the workflow run
    required: false
    default: error
  workingDirectory:
    description: Working directory for checks
    required: false
    default: ${{ github.workspace }}

runs:
  using: composite
  steps:
    # ‚úÖ Block Windows runners early
    - name: Check Runner Operating System üèÉ‚Äç‚ôÇÔ∏è
      if: runner.os == 'Windows'
      shell: bash
      run: |
        echo "::notice::run-clang-format action requires a macOS-based or Linux-based runner."
        exit 2

    # ‚úÖ Check for changed files
    - name: Check for Changed Files ‚úÖ
      uses: ./.github/actions/check-changes
      id: checks
      with:
        checkGlob: "'*.cpp' '*.hpp' '*.h' '*.c'"
        diffFilter: 'ACM'

    # ‚úÖ Install dependencies (clang-format)
    - name: Install Dependencies üõçÔ∏è
      if: runner.os == 'Linux' && fromJSON(steps.checks.outputs.hasChangedFiles)
      shell: bash
      run: |
        echo ::group::Install Dependencies
        sudo apt-get update
        sudo apt-get install -y clang-format
        echo ::endgroup::

    # ‚úÖ Run clang-format check
    - name: Run clang-format üêâ
      if: fromJSON(steps.checks.outputs.hasChangedFiles)
      id: clang-format-check
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        CHANGED_FILES: ${{ steps.checks.outputs.changedFiles }}
      run: |
        echo ::group::Run clang-format check
        changes=$(echo "${CHANGED_FILES}" | tr -d '[]"\'' | tr ',' ' ')
        echo "Checking formatting for: $changes"
        for file in $changes; do
          clang-format --dry-run --Werror "$file"
        done
        echo ::endgroup::

    # ‚úÖ Auto-fix if check fails
    - name: Auto-fix clang-format
      if: failure() && steps.clang-format-check.outcome == 'failure'
      shell: bash
      working-directory: ${{ github.workspace }}
      env:
        CHANGED_FILES: ${{ steps.checks.outputs.changedFiles }}
      run: |
        echo ::group::Auto-fix clang-format
        changes=$(echo "${CHANGED_FILES}" | tr -d '[]"\'' | tr ',' ' ')
        for file in $changes; do
          clang-format -i "$file"
        done
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add $changes
        git commit -m "Apply clang-format auto-fix"
        git push
        echo ::endgroup::